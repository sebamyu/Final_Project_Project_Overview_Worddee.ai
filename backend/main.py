# ==========================================
# üì¶ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Imports)
# ==========================================

from fastapi import FastAPI                 # ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Web Server
from pydantic import BaseModel              # ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢: ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (Data Validation)
from fastapi.middleware.cors import CORSMiddleware # ‡∏£‡∏õ‡∏†: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô (CORS)
import random                               # ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°: ‡πÉ‡∏ä‡πâ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
import httpx                                # ‡∏ô‡∏Å‡∏û‡∏¥‡∏£‡∏≤‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á Request ‡πÑ‡∏õ‡∏´‡∏≤ n8n ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô
import json                                 # ‡∏•‡πà‡∏≤‡∏°: ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå JSON
import os                                   # ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå: ‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏ä‡πá‡∏Ñ path ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
from datetime import datetime, timedelta    # ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤: ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤

# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏õ FastAPI
app = FastAPI()

# ==========================================
# üîì ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (CORS)
# ==========================================
# ‡∏õ‡∏Å‡∏ï‡∏¥ Browser ‡∏à‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤ Frontend (port 3000) ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö Backend (port 8000)
# ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡πá‡∏ö (origins=['*']) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ô‡∏∞"

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],    # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∏‡∏Å‡πÇ‡∏î‡πÄ‡∏°‡∏ô (‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô Production ‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ)
    allow_credentials=True, # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á cookies ‡∏´‡∏£‡∏∑‡∏≠ credentials ‡∏°‡∏≤‡πÑ‡∏î‡πâ
    allow_methods=["*"],    # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤ (GET, POST, PUT, DELETE)
    allow_headers=["*"],    # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∏‡∏Å Header
)

# ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô Database ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
DATA_FILE = "history.json"

# ==========================================
# üå± ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (Seed Data)
# ==========================================
# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÑ‡∏ß‡πâ "‡∏´‡∏•‡∏≠‡∏Å" ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡πÇ‡∏•‡πà‡∏á
# ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 6 ‡∏ß‡∏±‡∏ô ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
SEED_DATA = [
    # ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 6 ‡∏ß‡∏±‡∏ô
    {"date": (datetime.now() - timedelta(days=6)).strftime("%Y-%m-%d"), "display_date": (datetime.now() - timedelta(days=6)).strftime("%a"), "score": 5.0},
    {"date": (datetime.now() - timedelta(days=5)).strftime("%Y-%m-%d"), "display_date": (datetime.now() - timedelta(days=5)).strftime("%a"), "score": 6.5},
    {"date": (datetime.now() - timedelta(days=4)).strftime("%Y-%m-%d"), "display_date": (datetime.now() - timedelta(days=4)).strftime("%a"), "score": 4.0},
    {"date": (datetime.now() - timedelta(days=3)).strftime("%Y-%m-%d"), "display_date": (datetime.now() - timedelta(days=3)).strftime("%a"), "score": 8.5},
    {"date": (datetime.now() - timedelta(days=2)).strftime("%Y-%m-%d"), "display_date": (datetime.now() - timedelta(days=2)).strftime("%a"), "score": 7.0},
    # ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
    {"date": (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d"), "display_date": "Yesterday", "score": 9.0},
    # ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    {"date": datetime.now().strftime("%Y-%m-%d"), "display_date": "Today", "score": 9.5}
]

# ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Hardcoded Database) ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
WORDS_DB = [
    {
        "word": "Runway",
        "type": "Noun (‡∏Ñ‡∏≥‡∏ô‡∏≤‡∏°)",
        "pronunciation": "[run-way]",
        "meaning": "A strip of hard ground along which aircraft take off and land. (‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô)",
        "example": "The jet braked hard as its wheels touched the runway. (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô‡πÄ‡∏à‡πá‡∏ó‡πÄ‡∏ö‡∏£‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≠‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏£‡∏±‡∏ô‡πÄ‡∏ß‡∏¢‡πå)",

        "imageUrl": "https://images.unsplash.com/photo-1569154941061-e231b4725ef1?q=80&w=2070&auto=format&fit=crop"
    },
    {
        "word": "Aurora",
        "type": "Noun (‡∏Ñ‡∏≥‡∏ô‡∏≤‡∏°)",
        "pronunciation": "[uh-rawr-uh]",
        "meaning": "A natural electrical phenomenon characterized by the appearance of streamers of reddish or greenish light in the sky. (‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏™‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÅ‡∏™‡∏á‡πÉ‡∏ï‡πâ)",
        "example": "We stayed up all night to watch the breathtaking aurora borealis. (‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏ö‡∏≠‡∏î‡∏ô‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡πÅ‡∏™‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)",
        "imageUrl": "https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=2070&auto=format&fit=crop"
    },
    {
        "word": "Solitude",
        "type": "Noun (‡∏Ñ‡∏≥‡∏ô‡∏≤‡∏°)",
        "pronunciation": "[sol-i-tude]",
        "meaning": "The state or situation of being alone. (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ô‡πÇ‡∏î‡∏©)",
        "example": "She enjoyed the peace and solitude of the woods. (‡πÄ‡∏ò‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏á‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ô‡πÇ‡∏î‡∏©‡πÉ‡∏ô‡∏õ‡πà‡∏≤)",
        "imageUrl": "https://images.unsplash.com/photo-1499591934245-40b55745b905?q=80&w=2072&auto=format&fit=crop"
    }
]

# ==========================================
# üöÄ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: Startup Event (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Server)
# ==========================================
@app.on_event("startup")
async def startup_event():
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå history.json ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?
    if not os.path.exists(DATA_FILE):
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
        print(f"Creating new data file at: {os.path.abspath(DATA_FILE)}")
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            # ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SEED_DATA ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÑ‡∏õ
            json.dump(SEED_DATA, f, indent=4)
        print("‚úÖ Seed data written successfully!")
    else:
        # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏Ñ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        print(f"‚úÖ Found existing data file at: {os.path.abspath(DATA_FILE)}")

# ==========================================
# üõ†Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå (Helpers)
# ==========================================

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
def load_history():
    # ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ list ‡∏ß‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á
    if not os.path.exists(DATA_FILE):
        return []
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f) # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô List ‡∏Ç‡∏≠‡∏á Python
    except:
        return []

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà
def save_history(new_record):
    history = load_history()    # 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    history.append(new_record)  # 2. ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ (Append)
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(history, f, indent=4) # 3. ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°

# ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
# ==========================================
# üõ°Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Model)
# ==========================================
# ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà Frontend ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°
class SentenceInput(BaseModel):
    word: str       # ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ word ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° # üëà ‡∏ô‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå
    sentence: str   # ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ sentence ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° # üëà ‡πÅ‡∏•‡∏∞‡∏ô‡∏µ‡πà! ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà user ‡πÅ‡∏ï‡πà‡∏á‡∏°‡∏≤

# ==========================================
# üì° ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 7: API Endpoints (‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)
# ==========================================

# 1Ô∏è‚É£ API ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
# GET: /api/word
@app.get("/api/word")
async def get_random_word():
    # ‡∏™‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏¥‡∏ö 1 ‡∏ä‡∏¥‡πâ‡∏ô‡∏à‡∏≤‡∏Å WORDS_DB ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    return random.choice(WORDS_DB)

# 2Ô∏è‚É£ API ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤ n8n)
# POST: /api/validate-sentence
# ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° SentenceInput
@app.post("/api/validate-sentence")
async def validate_sentence(data: SentenceInput):
    # ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ URL ‡∏Ç‡∏≠‡∏á n8n (Webhook) ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Docker
    n8n_url = "http://localhost:5678/webhook/c2e79391-13ab-4f23-89c5-64e2e33f99fb"

    print(f"Sending data to n8n: {data.word} -> {data.sentence}")

    try:
        # ‡πÉ‡∏ä‡πâ httpx.AsyncClient ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Asynchronous (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
        async with httpx.AsyncClient() as client:
            # ‡∏¢‡∏¥‡∏á POST Request ‡πÑ‡∏õ‡∏´‡∏≤ n8n ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• word ‡πÅ‡∏•‡∏∞ sentence
            response = await client.post(n8n_url, json={"word": data.word, "sentence": data.sentence}, timeout=30.0)
            
            # ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å n8n (Score, Feedback, etc.)
            result = response.json()
            
            # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á history
            now = datetime.now()
            save_history({
                "date": now.strftime("%Y-%m-%d"),      # ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Streak)
                "display_date": now.strftime("%a %H:%M"), # ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤)
                "score": result.get("score", 0)        # ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å n8n
            })
            
            # ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ Frontend ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            return result

    except Exception as e:
        # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ n8n ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ Error ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        print(f"Error calling n8n: {e}")
        return {"score": 0, "level": "Error", "suggestion": "Connection failed", "corrected_sentence": ""}

# 3Ô∏è‚É£ API ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (Dashboard)
# GET: /api/summary
@app.get("/api/summary")
async def get_summary():
    history = load_history() # ‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Streak (‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô) ---
    # 1. ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ï‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å) ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (set) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    unique_dates = sorted(list(set(item["date"] for item in history)), reverse=True)
    
    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
    today_str = datetime.now().strftime("%Y-%m-%d")
    yesterday_str = (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d")
    
    current_streak = 0
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ Streak
    if unique_dates:
        # ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô ‡∏Ñ‡∏∑‡∏≠ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô" (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î‡∏ä‡πà‡∏ß‡∏á)
        if unique_dates[0] == today_str or unique_dates[0] == yesterday_str:
            check_date = datetime.now()
            
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö 1 ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
            if unique_dates[0] == today_str:
                current_streak = 1
                check_date = check_date - timedelta(days=1)
            
            # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ: ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (check_date) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            while check_date.strftime("%Y-%m-%d") in unique_dates:
                current_streak += 1 # ‡∏ö‡∏ß‡∏Å Streak ‡πÄ‡∏û‡∏¥‡πà‡∏°
                check_date = check_date - timedelta(days=1) # ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏±‡∏ô

    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á = 5 ‡∏ô‡∏≤‡∏ó‡∏µ)
    total_minutes = len(history) * 5

    # --- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü ---
    chart_data = []
    # ‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 7 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
    for item in history[-7:]:
        chart_data.append({
            "date": item.get("display_date", item["date"]), # ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡∏ô X
            "score": item["score"]                          # ‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô Y
        })

    # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ Dashboard
    return {
        "chart": chart_data,
        "stats": {
            "streak": current_streak,
            "minutes": total_minutes
        }
    }